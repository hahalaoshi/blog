---
title: 堆栈内存管理
date: 2020-05-11 00:46:42
tags:
  - stack
typora-root-url: ../../source
---

# 程序与内存的关系

虚拟内存带来的好处：

- 避免使用物理内存带来的弊端
- 为每个进程提供一个独立的，私有的地址空间
- 保护每个进程的空间不被其他进程破坏
- 内存读写权限管理，保障系统的安全运行

linux内存映像：

![image-20200511010457880](/images/heap-stack-memory/image-20200511010457880.png)



# 栈的初始化及大小

## 栈的类型

| 缩写 | 名称   | 指令        | 含义                                                         |
| ---- | ------ | ----------- | ------------------------------------------------------------ |
| FD   | 满递减 | stmfd/ldmfd | 堆栈通过减小存储器的地址向下增长，堆栈指针指向内含有效数据项的最低地址 |
| ED   | 空递减 | stmed/ldmed | 堆栈通过减小存储器的地址向下增长，堆栈指针指向堆栈下的第一个空位置 |
| FA   | 满递增 | stmfa/ldmfa | 堆栈通过增大存储器的地址向上增长，堆栈指针指向内含有效数据项的最高地址 |
|      | 空递增 | stmea/ldmea | 堆栈通过增大村吃器的地址向上增长，堆栈指针指向堆栈上的第一个空位置 |

## 栈的作用

- 函数参数
- 局部变量
- 函数返回值
- 编译器生成的临时变量

## 栈的初始化

 ![image-20200511011424002](/images/heap-stack-memory/image-20200511011424002.png)

**Tips**: ARM中SP是栈顶指针，FP是栈底指针

## 栈的起始地址

随机偏移--ASLR

### 实例

```shell
#查看进程内存映像
root@xmalloc:/proc/self# cat /proc/self/maps
```

## 栈的大小

linux进程栈大小：

```shell
#查看堆栈大小
ulimit -s
#设置堆栈大小
ulimit -s size
```

**Tips:** 调高堆栈容量会增加内存开销和启动时间

### 实例

源码路径：[stack_size.c][1]

构造栈溢出场景，调用`ulimit` 命令调高栈的大小，避免栈溢出



# 栈的管理：函数调用

## 栈帧



# 栈的管理：参数传递

[1]: https://github.com/hahalaoshi/blog-src/blob/master/heap-stack-memory/2/stack_size.c